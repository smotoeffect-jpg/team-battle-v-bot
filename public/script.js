<!-- /public/script.js -->
<script>
(() => {
  // =========================
  // Safety: ◊ú◊û◊†◊ï◊¢ ◊ñ◊ï◊ù/◊û◊ó◊ï◊ï◊™ ◊ë◊ú◊ô ◊ú◊ó◊°◊ï◊ù ◊î◊ß◊©◊ï◊™ ◊û◊î◊ô◊®◊ï◊™
  // =========================
  try {
    const st = document.createElement("style");
    st.textContent = `
      html, body { overscroll-behavior: none; touch-action: manipulation; }
      * { -webkit-tap-highlight-color: transparent; }
      input, button { touch-action: manipulation; }
    `;
    document.head.appendChild(st);
  } catch {}

  // =========================
  // Helpers
  // =========================
  const qs  = (s) => document.querySelector(s);
  const log = (...a) => { try { console.log("[TB]", ...a); } catch {} };
  const err = (...a) => { try { console.error("[TB]", ...a); } catch {} };

  // ◊î◊í◊†◊ï◊™ ◊û◊ï◊ú ◊ñ◊ï◊ù/◊û◊ó◊ï◊ï◊™ (◊ú◊ê ◊ó◊ï◊°◊ù ◊î◊ß◊©◊ï◊™ ◊û◊î◊ô◊®◊ï◊™/◊®◊ë◊ï◊™)
  let lastTouchEnd = 0;
  document.addEventListener("gesturestart", (e)=>{ e.preventDefault(); }, {passive:false});
  document.addEventListener("dblclick", (e)=>{ e.preventDefault(); }, {capture:true});
  document.addEventListener("touchend", (e)=>{
    const now = Date.now();
    if (now - lastTouchEnd <= 300) e.preventDefault();
    lastTouchEnd = now;
  }, {passive:false});
  document.addEventListener("touchmove", (e)=>{
    if (e.touches && e.touches.length > 1) e.preventDefault();
  }, {passive:false});

  // =========================
  // Config
  // =========================
  const API_BASE = (window.location.origin || "").replace(/\/$/, "");
  const BOT_USERNAME = "TeamBattle_vBot";

  // =========================
  // I18N ◊û◊ô◊†◊ô◊û◊ú◊ô (◊õ◊ì◊ô ◊©◊ú◊ê ◊ô◊ô◊§◊ï◊ú ◊ê◊ù ◊ó◊°◊®)
  // ◊ú◊§◊ô ◊ë◊ß◊©◊™◊ö: ◊î◊û◊ô◊ú◊î TAP ◊†◊©◊ê◊®◊™ TAP ◊ë◊õ◊ú ◊î◊©◊§◊ï◊™; ◊ë◊ú◊ô "+25" ◊ë◊õ◊§◊™◊ï◊® ◊°◊ï◊§◊®
  // =========================
  const I18N = {
    he: {
      israel: "üáÆüá± ◊ô◊©◊®◊ê◊ú", gaza: "üáµüá∏ ◊¢◊ñ◊î",
      tap: "TAP (+1)", super: "◊°◊ï◊§◊®÷æ◊ë◊ï◊°◊ò",
      rules: "‚≠ê 1 = 2 ◊†◊ß' ‚Ä¢ üí• 300 TAP/◊ô◊ï◊ù ‚Ä¢ ‚ö° ◊°◊ï◊§◊® ◊§◊¢◊ù ◊ë◊ô◊ï◊ù",
      chooseIL: "◊ë◊ó◊® ◊¶◊ï◊ï◊™ ◊ô◊©◊®◊ê◊ú üáÆüá±", chooseGA: "◊ë◊ó◊® ◊¶◊ï◊ï◊™ ◊¢◊ñ◊î üáµüá∏",
      donate: "Extra TAP +2",
      progress: (x,m)=>`${x} / ${m} TAP ◊î◊ô◊ï◊ù`,
      toastCopy: "◊î◊ß◊ô◊©◊ï◊® ◊î◊ï◊¢◊™◊ß",
      mustChoose: "◊ë◊ó◊® ◊™◊ó◊ô◊ú◊î ◊ß◊ë◊ï◊¶◊î",
      confirmSwitch: "◊ú◊î◊ó◊ú◊ô◊£ ◊ß◊ë◊ï◊¶◊î? ◊ñ◊î ◊ô◊©◊§◊ô◊¢ ◊¢◊ú ◊î◊†◊ô◊ß◊ï◊ì ◊î◊ë◊ê ◊©◊ú◊ö.",
      you: "◊ê◊™◊î", myPanel: "◊î◊ú◊ï◊ó ◊©◊ú◊ô",
      myStars: (n)=>`‚≠ê ◊õ◊ï◊õ◊ë◊ô◊ù ◊©◊™◊®◊û◊™◊ô: ${n}`,
      myBonus: (n)=>`üéÅ ◊ë◊ï◊†◊ï◊° ◊©◊ï◊™◊§◊ô◊ù ◊©◊ß◊ô◊ë◊ú◊™◊ô: ${n}‚≠ê`,
      myTaps:  (x,m)=>`üëÜ TAP ◊î◊ô◊ï◊ù: ${x}/${m}`,
      share: "üì§ ◊©◊™◊£ ◊ë◊ò◊ú◊í◊®◊ù", leaders: "◊©◊ó◊ß◊†◊ô◊ù ◊û◊ï◊ë◊ô◊ú◊ô◊ù",
      switched: "◊î◊ß◊ë◊ï◊¶◊î ◊î◊ï◊ó◊ú◊§◊î ‚úÖ", partners: "◊™◊ï◊õ◊†◊ô◊™ ◊©◊ï◊™◊§◊ô◊ù ü§ù",
      copyLink:"◊î◊¢◊™◊ß ◊ß◊ô◊©◊ï◊®",
      paidCancelled:"◊î◊™◊©◊ú◊ï◊ù ◊ë◊ï◊ò◊ú ◊ê◊ï ◊†◊õ◊©◊ú",
      invErr:"◊©◊í◊ô◊ê◊î ◊ë◊ô◊¶◊ô◊®◊™ ◊ó◊©◊ë◊ï◊†◊ô◊™",
      hitLimit:"◊î◊í◊¢◊™ ◊ú◊û◊í◊ë◊ú◊™ ◊î-TAP ◊î◊ô◊ï◊û◊ô◊™",
      usedSuper:"◊õ◊ë◊® ◊î◊©◊™◊û◊©◊™ ◊ë◊°◊ï◊§◊®÷æ◊ë◊ï◊°◊ò ◊î◊ô◊ï◊ù"
    },
    en: {
      israel:"üáÆüá± Israel", gaza:"üáµüá∏ Gaza",
      tap:"TAP (+1)", super:"Super Boost",
      rules:"‚≠ê 1 = 2 pts ‚Ä¢ üí• 300 TAP/day ‚Ä¢ ‚ö° Super once/day",
      chooseIL:"Join Team Israel üáÆüá±", chooseGA:"Join Team Gaza üáµüá∏",
      donate:"Extra TAP +2",
      progress:(x,m)=>`${x} / ${m} TAP today`,
      toastCopy:"Link copied",
      mustChoose:"Pick a team first",
      confirmSwitch:"Switch team? This affects your next points.",
      you:"You", myPanel:"My Panel",
      myStars:(n)=>`‚≠ê Stars I donated: ${n}`,
      myBonus:(n)=>`üéÅ Referral bonus I got: ${n}‚≠ê`,
      myTaps:(x,m)=>`üëÜ TAP today: ${x}/${m}`,
      share:"üì§ Share on Telegram", leaders:"Top Players",
      switched:"Team switched ‚úÖ", partners:"Affiliate Program ü§ù",
      copyLink:"Copy Link",
      paidCancelled:"Payment cancelled or failed",
      invErr:"Invoice creation error",
      hitLimit:"Daily TAP limit reached",
      usedSuper:"Super already used today"
    },
    ar: {
      israel:"üáÆüá± ÿ•ÿ≥ÿ±ÿßÿ¶ŸäŸÑ", gaza:"üáµüá∏ ÿ∫ÿ≤ÿ©",
      tap:"TAP (+1)", super:"ÿ≥Ÿàÿ®ÿ± ÿ®Ÿàÿ≥ÿ™",
      rules:"‚≠ê 1 = ŸÜŸÇÿ∑ÿ™ÿßŸÜ ‚Ä¢ üí• Ÿ£Ÿ†Ÿ† TAP/ŸäŸàŸÖ ‚Ä¢ ‚ö° ÿ≥Ÿàÿ®ÿ± ŸÖÿ±ÿ©/ŸäŸàŸÖ",
      chooseIL:"ÿßŸÜÿ∂ŸÖ ŸÑŸÅÿ±ŸäŸÇ ÿ•ÿ≥ÿ±ÿßÿ¶ŸäŸÑ üáÆüá±", chooseGA:"ÿßŸÜÿ∂ŸÖ ŸÑŸÅÿ±ŸäŸÇ ÿ∫ÿ≤ÿ© üáµüá∏",
      donate:"Extra TAP +2",
      progress:(x,m)=>`${x} / ${m} TAP ÿßŸÑŸäŸàŸÖ`,
      toastCopy:"ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑",
      mustChoose:"ÿßÿÆÿ™ÿ± ŸÅÿ±ŸäŸÇŸãÿß ÿ£ŸàŸÑŸãÿß",
      confirmSwitch:"ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÅÿ±ŸäŸÇÿü ÿ≥Ÿäÿ§ÿ´ÿ± ÿπŸÑŸâ ŸÜŸÇÿßÿ∑ŸÉ ÿßŸÑŸÇÿßÿØŸÖÿ©.",
      you:"ÿ£ŸÜÿ™", myPanel:"ŸÑŸàÿ≠ÿ™Ÿä",
      myStars:(n)=>`‚≠ê ÿßŸÑŸÜÿ¨ŸàŸÖ ÿßŸÑÿ™Ÿä ÿ™ÿ®ÿ±ÿπÿ™ ÿ®Ÿáÿß: ${n}`,
      myBonus:(n)=>`üéÅ ŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©: ${n}‚≠ê`,
      myTaps:(x,m)=>`üëÜ TAP ÿßŸÑŸäŸàŸÖ: ${x}/${m}`,
      share:"üì§ ÿ¥ÿßÿ±ŸÉ ÿπŸÑŸâ ÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ", leaders:"ÿßŸÑŸÑÿßÿπÿ®ŸàŸÜ ÿßŸÑŸÖÿ™ÿµÿØÿ±ŸàŸÜ",
      switched:"ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÅÿ±ŸäŸÇ ‚úÖ", partners:"ÿ®ÿ±ŸÜÿßŸÖÿ¨ ÿßŸÑÿ¥ÿ±ŸÉÿßÿ° ü§ù",
      copyLink:"ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑",
      paidCancelled:"ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿØŸÅÿπ ÿ£Ÿà ŸÅÿ¥ŸÑ",
      invErr:"ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©",
      hitLimit:"ÿ®ŸÑÿ∫ÿ™ ÿ≠ÿØ TAP ÿßŸÑŸäŸàŸÖŸä",
      usedSuper:"ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ≥Ÿàÿ®ÿ± ÿßŸÑŸäŸàŸÖ"
    }
  };

  // =========================
  // State
  // =========================
  let LANG = localStorage.getItem("tb_lang") || "he";
  let USER_ID = null;
  let TEAM = null;
  let tapsToday = 0;
  let tapsLimit = 300;

  // Telegram init ‚Äì ◊†◊ñ◊î◊î user id ◊ê◊ù ◊ñ◊û◊ô◊ü, ◊ê◊ó◊®◊™ ◊†◊©◊û◊ï◊® ◊û◊ñ◊î◊î ◊û◊ß◊ï◊û◊ô
  try {
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
      const unsafe = Telegram.WebApp.initDataUnsafe || {};
      USER_ID = unsafe.user?.id ? String(unsafe.user.id) : null;
    }
  } catch(e){ err("TG init fail", e); }

  if (!USER_ID) {
    USER_ID = localStorage.getItem("tb_user_id") || String(Math.floor(Math.random()*1e12));
    localStorage.setItem("tb_user_id", USER_ID);
  }

  // =========================
  // Elements (◊ú◊ê ◊†◊ï◊§◊ú ◊ê◊ù ◊ó◊°◊®)
  // =========================
  const els = {
    scoreIL:   qs("#score-israel"),
    scoreGA:   qs("#score-gaza"),
    tap:       qs("#tap-btn"),
    super:     qs("#super-btn"),
    rules:     qs("#rules"),
    prog:      qs("#progress-text"),
    donate:    qs("#donate-btn"),
    stars:     qs("#stars"),
    chooseIL:  qs("#choose-israel"),
    chooseGA:  qs("#choose-gaza"),
    refInput:  qs("#ref-link"),
    copy:      qs("#copy-link"),
    share:     qs("#share-btn"),
    toast:     qs("#toast"),
    switchTm:  qs("#switch-team"),
    meStars:   qs("#me-stars"),
    meBonus:   qs("#me-bonus"),
    meTaps:    qs("#me-taps"),
    leaders:   qs("#leaderboard"),
    teamChooser: qs("#team-chooser"),
    titleIL:   qs("#team-israel"),
    titleGA:   qs("#team-gaza"),
  };

  // ◊õ◊ì◊ô ◊ú◊û◊†◊ï◊¢ ◊û◊¶◊ë ◊©◊ú "◊û◊õ◊ï◊ë◊î" ◊ï◊ô◊ñ◊ï◊ê◊ú◊ô◊™, ◊†◊ë◊ò◊ô◊ó ◊©◊î◊õ◊§◊™◊ï◊® ◊î◊¶◊î◊ï◊ë ◊™◊û◊ô◊ì ◊†◊ô◊™◊ü ◊ú◊ú◊ó◊ô◊¶◊î ◊û◊î◊¶◊ì ◊©◊ú ◊î-DOM
  if (els.donate) {
    try {
      els.donate.disabled = false;
      els.donate.style.pointerEvents = "auto";
      els.donate.style.opacity = "1";
      els.donate.setAttribute("aria-disabled", "false");
      els.donate.addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); }, {passive:false});
    } catch {}
  }

  function buildRefLink(uid = USER_ID) {
    return `https://t.me/${BOT_USERNAME}?start=ref_${uid}`;
  }
  function toast(msg) {
    if (!els.toast) { alert(msg); return; }
    els.toast.textContent = msg;
    els.toast.style.display = "block";
    setTimeout(()=>{ els.toast.style.display = "none"; }, 1500);
  }

  // =========================
  // Language
  // =========================
  function applyLangTexts() {
    const t = I18N[LANG] || I18N.he;
    if (els.titleIL)  els.titleIL.textContent  = t.israel;
    if (els.titleGA)  els.titleGA.textContent  = t.gaza;
    if (els.tap)      els.tap.textContent      = t.tap;
    if (els.super)    els.super.textContent    = t.super;
    const rulesEl = els.rules || qs(".rule");
    if (rulesEl) rulesEl.textContent = t.rules;
    if (els.chooseIL) els.chooseIL.textContent = t.chooseIL;
    if (els.chooseGA) els.chooseGA.textContent = t.chooseGA;
    if (els.donate)   els.donate.textContent   = t.donate;
    const aff = qs(".affiliate-title");
    if (aff) aff.textContent = t.partners || "Affiliate Program ü§ù";
    if (els.copy)     els.copy.textContent     = t.copyLink;
    if (els.share)    els.share.textContent    = t.share;
    const lt = qs("#leaders-title");
    if (lt) lt.textContent = t.leaders;
    const mp = qs("#my-panel-title");
    if (mp) mp.textContent = t.myPanel;
    if (els.prog)     els.prog.textContent     = t.progress(tapsToday, tapsLimit);
    if (els.meStars)  els.meStars.textContent  = t.myStars( Number(els.meStars?.dataset?.v || 0) );
    if (els.meBonus)  els.meBonus.textContent  = t.myBonus( Number(els.meBonus?.dataset?.v || 0) );
    if (els.meTaps)   els.meTaps.textContent   = t.myTaps(tapsToday, tapsLimit);
  }

  // =========================
  // API
  // =========================
  async function apiGet(p) {
    try {
      const r = await fetch(`${API_BASE}${p}`, { credentials:"omit" });
      return await r.json();
    } catch(e){ err("GET fail", p, e); return {}; }
  }
  async function apiPost(p, b) {
    try {
      const r = await fetch(`${API_BASE}${p}`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(b || {})
      });
      return await r.json();
    } catch(e){ err("POST fail", p, e); return {}; }
  }

  // =========================
  // State fetchers
  // =========================
  async function fetchState() {
    const j = await apiGet("/api/state");
    if (j?.ok && j.scores) {
      if (els.scoreIL) els.scoreIL.textContent = j.scores.israel ?? 0;
      if (els.scoreGA) els.scoreGA.textContent = j.scores.gaza ?? 0;
    }
  }

  async function fetchMe() {
    const j = await apiGet(`/api/me?userId=${encodeURIComponent(USER_ID)}`);
    if (!j?.ok || !j.me) return;
    const me = j.me || {};
    TEAM = me.team || TEAM;
    tapsToday = typeof me.tapsToday === "number" ? me.tapsToday : tapsToday;
    tapsLimit = typeof j.limit === "number" ? j.limit : tapsLimit;

    // ◊ú◊ê◊ó◊® ◊ë◊ó◊ô◊®◊™ ◊ß◊ë◊ï◊¶◊î: ◊ú◊§◊™◊ï◊ó ◊õ◊ú ◊î◊õ◊§◊™◊ï◊®◊ô◊ù (◊õ◊ï◊ú◊ú ◊î◊¶◊î◊ï◊ë)
    if (TEAM && els.teamChooser) {
      els.teamChooser.style.display = "none";
      if (els.tap)    els.tap.disabled    = false;
      if (els.super)  els.super.disabled  = false;
      if (els.donate) { els.donate.disabled = false; els.donate.style.pointerEvents="auto"; els.donate.style.opacity="1"; }
    }

    if (els.meStars) {
      els.meStars.dataset.v = String(me.starsDonated ?? 0);
      els.meStars.textContent = (I18N[LANG]||I18N.he).myStars(me.starsDonated ?? 0);
    }
    if (els.meBonus) {
      els.meBonus.dataset.v = String(me.bonusStars ?? 0);
      els.meBonus.textContent = (I18N[LANG]||I18N.he).myBonus(me.bonusStars ?? 0);
    }
    if (els.meTaps) els.meTaps.textContent = (I18N[LANG]||I18N.he).myTaps(tapsToday, tapsLimit);
    if (els.prog)   els.prog.textContent = (I18N[LANG]||I18N.he).progress(tapsToday, tapsLimit);
  }

  async function fetchLeaders() {
    const j = await apiGet("/api/leaderboard");
    if (!j?.ok || !Array.isArray(j.top) || !els.leaders) return;
    const t = I18N[LANG] || I18N.he;
    els.leaders.innerHTML = "";
    j.top.slice(0, 20).forEach((u, i) => {
      const li = document.createElement("div");
      li.className = "leader-row";
      const rank = i + 1;
      const name = u.displayName || u.username || (u.userId === USER_ID ? t.you : `Player ${u.userId?.slice(-4)||""}`);
      const points = u.points ?? (u.starsDonated ? u.starsDonated * 2 : 0);
      li.textContent = `${rank}. ${name} ‚Äî ${points} pts`;
      els.leaders.appendChild(li);
    });
  }

  // =========================
  // Actions
  // =========================
  async function selectTeam(team) {
    const j = await apiPost("/api/select-team", { userId: USER_ID, team });
    if (j?.ok) {
      TEAM = team;
      if (els.teamChooser) els.teamChooser.style.display = "none";
      if (els.tap)    els.tap.disabled    = false;
      if (els.super)  els.super.disabled  = false;
      if (els.donate) { els.donate.disabled=false; els.donate.style.pointerEvents="auto"; els.donate.style.opacity="1"; }
      const ref = buildRefLink(USER_ID);
      if (els.refInput) els.refInput.value = ref;
      await Promise.all([fetchState(), fetchMe(), fetchLeaders()]);
    }
  }

  async function handleTap() {
    if (!TEAM) return toast((I18N[LANG]||I18N.he).mustChoose);
    const j = await apiPost("/api/tap", { userId: USER_ID });
    if (j?.ok) await Promise.all([fetchState(), fetchMe(), fetchLeaders()]);
    else if (j?.error === "limit") toast((I18N[LANG]||I18N.he).hitLimit);
  }

  async function handleSuper() {
    if (!TEAM) return toast((I18N[LANG]||I18N.he).mustChoose);
    const j = await apiPost("/api/super", { userId: USER_ID });
    if (j?.ok) await Promise.all([fetchState(), fetchMe(), fetchLeaders()]);
    else if (j?.error === "limit") toast((I18N[LANG]||I18N.he).usedSuper);
  }

  // ====== ◊õ◊§◊™◊ï◊® ◊¶◊î◊ï◊ë ‚Äì ◊†◊õ◊™◊ë ◊û◊ó◊ì◊©, ◊ô◊¶◊ô◊ë, ◊¢◊ï◊ë◊ì ◊ë◊û◊ï◊ë◊ô◊ô◊ú ◊ï◊ë◊ò◊ú◊í◊®◊ù ======
  async function openInvoice(url) {
    // 1) Telegram in-app
    try {
      if (window.Telegram?.WebApp?.openInvoice) {
        await new Promise((resolve, reject) => {
          Telegram.WebApp.openInvoice(url, (status) => {
            if (status === "paid" || status === "pending") resolve();
            else reject(new Error(status || "failed"));
          });
        });
        return true;
      }
    } catch(_) {}

    // 2) Telegram openLink fallback
    try {
      if (window.Telegram?.WebApp?.openLink) {
        Telegram.WebApp.openLink(url, { try_instant_view: false });
        return true;
      }
    } catch(_) {}

    // 3) Browser fallback
    try { window.open(url, "_blank", "noopener,noreferrer"); } catch {}
    return true;
  }

  async function handleDonate(ev) {
    try {
      // ◊†◊ë◊ò◊ô◊ó ◊©◊ê◊ô◊ü ◊ë◊ô◊ò◊ï◊ú/◊ë◊ú◊ô◊¢◊î ◊û◊û◊ß◊ï◊û◊ï◊™ ◊ê◊ó◊®◊ô◊ù
      if (ev) { ev.preventDefault(); ev.stopPropagation(); }

      // ◊†◊ë◊ò◊ô◊ó ◊©◊î◊õ◊§◊™◊ï◊® ◊ú◊ê "◊û◊õ◊ï◊ë◊î" ◊ï◊ô◊ñ◊ï◊ê◊ú◊ô◊™
      if (els.donate) { els.donate.disabled=false; els.donate.style.pointerEvents="auto"; els.donate.style.opacity="1"; }

      if (!TEAM) { toast((I18N[LANG]||I18N.he).mustChoose); return; }

      const starsInput = els.stars;
      let stars = 1;
      if (starsInput) {
        const v = parseInt(starsInput.value, 10);
        stars = Number.isFinite(v) && v>=1 ? v : 1;
      }

      const j = await apiPost("/api/create-invoice", { userId: USER_ID, team: TEAM, stars });
      if (j?.ok && j.url) {
        // ◊§◊ï◊™◊ó◊ô◊ù ◊ó◊©◊ë◊ï◊†◊ô◊™ ◊ï◊û◊®◊¢◊†◊†◊ô◊ù ◊û◊¶◊ë ◊ú◊õ◊û◊î ◊©◊†◊ô◊ï◊™
        try {
          await openInvoice(j.url);
          const started = Date.now();
          const poll = async () => {
            await Promise.all([fetchState(), fetchMe(), fetchLeaders()]);
            if (Date.now() - started < 25000) setTimeout(poll, 2500);
          };
          setTimeout(poll, 3000);
        } catch {
          toast((I18N[LANG]||I18N.he).paidCancelled);
        }
      } else {
        toast((I18N[LANG]||I18N.he).invErr);
      }
    } catch(e) {
      err("donate error", e);
      toast((I18N[LANG]||I18N.he).invErr);
    }
  }

  function wireClipboardAndShare() {
    if (els.refInput) els.refInput.value = buildRefLink(USER_ID);
    if (els.copy) els.copy.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(els.refInput.value);
        toast((I18N[LANG]||I18N.he).toastCopy);
      } catch { toast("◊ú◊ê ◊î◊¶◊ú◊ó◊™◊ô ◊ú◊î◊¢◊™◊ô◊ß"); }
    });
    if (els.share) els.share.addEventListener("click", () => {
      const link = buildRefLink(USER_ID);
      const url = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent("◊ë◊ï◊ê◊ï ◊ú◊©◊ó◊ß ◊ê◊ô◊™◊ô ◊ë-TeamBattle!")}`;
      window.open(url, "_blank");
    });
  }

  // =========================
  // Event Delegation
  // =========================
  document.addEventListener("click", (ev) => {
    const el = ev.target.closest("button, a, input[type=button]");
    if (!el) return;

    switch (el.id) {
      case "choose-israel": ev.preventDefault(); selectTeam("israel"); break;
      case "choose-gaza":   ev.preventDefault(); selectTeam("gaza");   break;
      case "tap-btn":       ev.preventDefault(); handleTap();          break;
      case "super-btn":     ev.preventDefault(); handleSuper();        break;

      // ◊î◊õ◊§◊™◊ï◊® ◊î◊¶◊î◊ï◊ë ‚Äì ◊ó◊ï◊ë◊î ◊ú◊î◊§◊¢◊ô◊ú ◊õ◊ê◊ü; ◊ê◊ù ◊ô◊© bubble ◊ú◊û◊¢◊ú◊î, ◊ê◊†◊ó◊†◊ï ◊¢◊ï◊¶◊®◊ô◊ù
      case "donate-btn":
        ev.preventDefault();
        ev.stopPropagation();
        handleDonate(ev);
        break;

      case "switch-team":
        ev.preventDefault();
        if (!TEAM) { toast((I18N[LANG]||I18N.he).mustChoose); break; }
        if (!confirm((I18N[LANG]||I18N.he).confirmSwitch)) break;
        apiPost("/api/switch-team", { userId: USER_ID, newTeam: TEAM === "israel" ? "gaza" : "israel" })
          .then(async (j)=>{
            if (j?.ok) { TEAM = j.team; toast((I18N[LANG]||I18N.he).switched); await Promise.all([fetchState(), fetchMe(), fetchLeaders()]); }
          });
        break;
      default: break;
    }
  }, {passive:false});

  // =========================
  // Language toggle buttons (◊ê◊ù ◊ß◊ô◊ô◊û◊ô◊ù)
  // =========================
  document.querySelectorAll(".lang-buttons button").forEach((b) => {
    b.addEventListener("click", () => {
      const lang = b.dataset.lang;
      if (I18N[lang]) {
        LANG = lang;
        localStorage.setItem("tb_lang", LANG);
        applyLangTexts();
        fetchLeaders();
        fetchMe();
      }
    });
  });

  // =========================
  // Init
  // =========================
  document.addEventListener("DOMContentLoaded", () => {
    try { wireClipboardAndShare(); } catch(e){ err(e); }
    try { applyLangTexts(); } catch(e){ err(e); }

    // ◊†◊ë◊ò◊ô◊ó ◊©◊û◊¶◊ì ◊î-DOM, ◊î◊õ◊§◊™◊ï◊® ◊î◊¶◊î◊ï◊ë ◊ú◊¢◊ï◊ú◊ù ◊ú◊ê "◊†◊¢◊ï◊ú"
    if (els.donate) { els.donate.disabled=false; els.donate.style.pointerEvents="auto"; els.donate.style.opacity="1"; }

    fetchState();
    fetchMe();
    fetchLeaders();
    setInterval(fetchState, 10000);
    setInterval(fetchLeaders, 15000);
  });
})();
</script>
