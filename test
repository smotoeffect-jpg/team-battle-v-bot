if (data.startsWith("panel:")) {
  if (!admins.includes(uid)) {
    await tgPost("answerCallbackQuery", {
      callback_query_id: cq.id,
      text: tt.unauthorized,
      show_alert: true
    });
  } else {
    const [, action, extra] = data.split(":");

    // ====== TOGGLE DEV MODE ======
    if (action === "toggle_dev") {
      settings.dev_mode = !settings.dev_mode;
      writeJSON(SETTINGS_FILE, settings);

      await tgPost("answerCallbackQuery", {
        callback_query_id: cq.id,
        text: settings.dev_mode
          ? (lang === "he" ? "üß© ◊û◊¶◊ë ◊§◊ô◊™◊ï◊ó ◊î◊ï◊§◊¢◊ú" : "üß© Dev Mode Enabled")
          : (lang === "he" ? "üåç ◊û◊¶◊ë ◊§◊ô◊™◊ï◊ó ◊õ◊ï◊ë◊î" : "üåç Dev Mode Disabled")
      });

      await editToMainPanel(msg, lang);
    }

    // ====== Welcome & Broadcast Manager (HE + EN) ======
    else if (action === "welcome") {
      await tgPost("editMessageText", {
        chat_id: msg.chat.id,
        message_id: msg.message_id,
        text:
          lang === "he"
            ? "üí¨ ◊¢◊®◊ô◊õ◊™ ◊î◊ï◊ì◊¢◊™ ◊§◊™◊ô◊ó◊î\n◊ë◊ó◊® ◊û◊î ◊ë◊®◊¶◊ï◊†◊ö ◊ú◊¢◊®◊ï◊ö:"
            : "üí¨ Edit Welcome Message\nChoose what to edit:",
        reply_markup: {
          inline_keyboard: [
            [{ text: lang === "he" ? "‚úèÔ∏è ◊ò◊ß◊°◊ò" : "‚úèÔ∏è Text", callback_data: "panel:welcome_text" }],
            [{ text: lang === "he" ? "üéõÔ∏è ◊õ◊§◊™◊ï◊®◊ô◊ù" : "üéõÔ∏è Buttons", callback_data: "panel:welcome_buttons" }],
            [{ text: lang === "he" ? "‚¨ÖÔ∏è ◊ó◊ñ◊®◊î" : "‚¨ÖÔ∏è Back", callback_data: "panel:main" }]
          ]
        }
      });
    }

    else if (action === "welcome_text") {
      setAdminAwait(uid, "welcome_text");
      await tgPost("editMessageText", {
        chat_id: msg.chat.id,
        message_id: msg.message_id,
        text:
          lang === "he"
            ? "◊©◊ú◊ó ◊ê◊™ ◊î◊ï◊ì◊¢◊™ ◊î◊§◊ï◊°◊ò.\n\n◊†◊ô◊™◊ü ◊ú◊î◊©◊™◊û◊© ◊ë◊û◊ô◊ú◊ï◊™ ◊û◊§◊™◊ó ◊©◊ô◊ï◊ó◊ú◊§◊ï ◊ë◊†◊™◊ï◊†◊ô ◊î◊û◊©◊™◊û◊©:\n‚Ä¢ %firstname% ‚Ä¢ %lastname% ‚Ä¢ %username% ‚Ä¢ %mention%"
            : "Send the post text.\n\nYou can use these placeholders:\n‚Ä¢ %firstname% ‚Ä¢ %lastname% ‚Ä¢ %username% ‚Ä¢ %mention%",
        reply_markup: {
          inline_keyboard: [
            [{ text: lang === "he" ? "‚¨ÖÔ∏è ◊ó◊ñ◊®◊î" : "‚¨ÖÔ∏è Back", callback_data: "panel:welcome" }]
          ]
        }
      });
    }

    else if (action === "welcome_buttons") {
      setAdminAwait(uid, "welcome_buttons");
      await tgPost("editMessageText", {
        chat_id: msg.chat.id,
        message_id: msg.message_id,
        text:
          lang === "he"
            ? "◊î◊í◊ì◊® ◊ê◊™ ◊î◊õ◊§◊™◊ï◊®◊ô◊ù ◊ú◊î◊ï◊°◊§◊î ◊ë◊û◊ß◊ú◊ì◊™ ◊û◊™◊ó◊™ ◊ú◊§◊ï◊°◊ò.\n\n‚Ä¢ ◊©◊ï◊®◊ï◊™ ◊û◊®◊ï◊ë◊ï◊™:\nButton text - t.me/LinkExample\nButton text - t.me/LinkExample\n\n‚Ä¢ ◊û◊°◊§◊® ◊ú◊ó◊¶◊†◊ô◊ù ◊ë◊©◊ï◊®◊î ◊ê◊ó◊™:\nButton text - t.me/LinkExample && Button text - t.me/LinkExample\n\n‚Ä¢ ◊ó◊ú◊ï◊ü ◊ß◊ï◊§◊•:\nButton text - popup: Text\nButton text - alert: Text\n\n‚Ä¢ ◊ú◊ó◊¶◊ü ◊©◊ô◊™◊ï◊£:\nButton text - share: Text\n\n‚Ä¢ ◊™◊§◊®◊ô◊ò / ◊©◊ï◊™◊§◊ô◊ù:\nButton text - menu: ◊©◊ù ◊™◊§◊®◊ô◊ò\nButton text - ref: ◊û◊ï◊°◊ô◊£ ◊ú◊ó◊¶◊ü ◊™◊ï◊õ◊†◊ô◊™ ◊©◊ï◊™◊§◊ô◊ù\n\n◊ú◊î◊ó◊ñ◊®◊™ ◊î◊û◊©◊™◊û◊© ◊ú◊™◊§◊®◊ô◊ò ◊î◊î◊™◊ó◊ú◊î: menu:start"
            : "Define buttons to add below the post.\n\n‚Ä¢ Multiple rows:\nButton text - t.me/LinkExample\nButton text - t.me/LinkExample\n\n‚Ä¢ Multiple buttons in one row:\nButton text - t.me/LinkExample && Button text - t.me/LinkExample\n\n‚Ä¢ Popup or Alert:\nButton text - popup: Text\nButton text - alert: Text\n\n‚Ä¢ Share button:\nButton text - share: Text\n\n‚Ä¢ Menu / Referral:\nButton text - menu: menuName\nButton text - ref: adds referral button\n\nTo return user to start: menu:start",
        reply_markup: {
          inline_keyboard: [
            [{ text: lang === "he" ? "‚¨ÖÔ∏è ◊ó◊ñ◊®◊î" : "‚¨ÖÔ∏è Back", callback_data: "panel:welcome" }]
          ]
        }
      });
    }

    // ====== Broadcast ======
    else if (action === "bc") {
      await tgPost("editMessageText", {
        chat_id: msg.chat.id,
        message_id: msg.message_id,
        text:
          lang === "he"
            ? "üì¢ ◊†◊ô◊î◊ï◊ú ◊î◊ï◊ì◊¢◊™ ◊©◊ô◊ì◊ï◊®\n◊ë◊ó◊® ◊û◊î ◊ë◊®◊¶◊ï◊†◊ö ◊ú◊¢◊®◊ï◊ö:"
            : "üì¢ Broadcast Message\nChoose what to edit:",
        reply_markup: {
          inline_keyboard: [
            [{ text: lang === "he" ? "‚úèÔ∏è ◊ò◊ß◊°◊ò" : "‚úèÔ∏è Text", callback_data: "panel:bc_text" }],
            [{ text: lang === "he" ? "üéõÔ∏è ◊õ◊§◊™◊ï◊®◊ô◊ù" : "üéõÔ∏è Buttons", callback_data: "panel:bc_buttons" }],
            [{ text: lang === "he" ? "‚úÖ ◊ê◊©◊® ◊ï◊©◊ú◊ó" : "‚úÖ Confirm & Send", callback_data: "panel:bc_send" }],
            [{ text: lang === "he" ? "‚¨ÖÔ∏è ◊ó◊ñ◊®◊î" : "‚¨ÖÔ∏è Back", callback_data: "panel:main" }]
          ]
        }
      });
    }

    else if (action === "bc_text") {
      setAdminAwait(uid, "broadcast_text");
      await tgPost("editMessageText", {
        chat_id: msg.chat.id,
        message_id: msg.message_id,
        text:
          lang === "he"
            ? "◊©◊ú◊ó ◊ê◊™ ◊î◊ï◊ì◊¢◊™ ◊î◊©◊ô◊ì◊ï◊®.\n\n◊†◊ô◊™◊ü ◊ú◊î◊©◊™◊û◊© ◊ë◊û◊ô◊ú◊ï◊™ ◊û◊§◊™◊ó ◊©◊ô◊ï◊ó◊ú◊§◊ï ◊ë◊†◊™◊ï◊†◊ô ◊î◊û◊©◊™◊û◊©:\n‚Ä¢ %firstname% ‚Ä¢ %lastname% ‚Ä¢ %username% ‚Ä¢ %mention%"
            : "Send the broadcast message.\n\nYou can use these placeholders:\n‚Ä¢ %firstname% ‚Ä¢ %lastname% ‚Ä¢ %username% ‚Ä¢ %mention%",
        reply_markup: {
          inline_keyboard: [
            [{ text: lang === "he" ? "‚¨ÖÔ∏è ◊ó◊ñ◊®◊î" : "‚¨ÖÔ∏è Back", callback_data: "panel:bc" }]
          ]
        }
      });
    }

    else if (action === "bc_buttons") {
      setAdminAwait(uid, "broadcast_buttons");
      await tgPost("editMessageText", {
        chat_id: msg.chat.id,
        message_id: msg.message_id,
        text:
          lang === "he"
            ? "◊î◊í◊ì◊® ◊ê◊™ ◊î◊õ◊§◊™◊ï◊®◊ô◊ù ◊ú◊î◊ï◊°◊§◊î ◊ë◊û◊ß◊ú◊ì◊™ ◊û◊™◊ó◊™ ◊ú◊§◊ï◊°◊ò.\n\n‚Ä¢ ◊©◊ï◊®◊ï◊™ ◊û◊®◊ï◊ë◊ï◊™:\nButton text - t.me/LinkExample\nButton text - t.me/LinkExample\n\n‚Ä¢ ◊û◊°◊§◊® ◊ú◊ó◊¶◊†◊ô◊ù ◊ë◊©◊ï◊®◊î ◊ê◊ó◊™:\nButton text - t.me/LinkExample && Button text - t.me/LinkExample\n\n‚Ä¢ ◊ó◊ú◊ï◊ü ◊ß◊ï◊§◊•:\nButton text - popup: Text\nButton text - alert: Text\n\n‚Ä¢ ◊ú◊ó◊¶◊ü ◊©◊ô◊™◊ï◊£:\nButton text - share: Text\n\n‚Ä¢ ◊™◊§◊®◊ô◊ò / ◊©◊ï◊™◊§◊ô◊ù:\nButton text - menu: menuName\nButton text - ref: adds referral button\n\n◊ú◊î◊ó◊ñ◊®◊™ ◊î◊û◊©◊™◊û◊© ◊ú◊™◊§◊®◊ô◊ò ◊î◊î◊™◊ó◊ú◊î: menu:start"
            : "Define buttons below the message.\n\n‚Ä¢ Multiple rows:\nButton text - t.me/LinkExample\nButton text - t.me/LinkExample\n\n‚Ä¢ Multiple buttons in one row:\nButton text - t.me/LinkExample && Button text - t.me/LinkExample\n\n‚Ä¢ Popup / Alert:\nButton text - popup: Text\nButton text - alert: Text\n\n‚Ä¢ Share button:\nButton text - share: Text\n\n‚Ä¢ Menu / Referral:\nButton text - menu: menuName\nButton text - ref: adds referral button\n\nTo return user to start: menu:start",
        reply_markup: {
          inline_keyboard: [
            [{ text: lang === "he" ? "‚¨ÖÔ∏è ◊ó◊ñ◊®◊î" : "‚¨ÖÔ∏è Back", callback_data: "panel:bc" }]
          ]
        }
      });
    }

    else if (action === "bc_send") {
      const draft = settings.broadcast_draft || { text: "", buttons: [] };
      const uSelf = ensureUser(uid);
      const preview = renderPlaceholders(draft.text || "", uSelf, uid);

      await tgPost("editMessageText", {
        chat_id: msg.chat.id,
        message_id: msg.message_id,
        text:
          (lang === "he"
            ? "üìù ◊™◊¶◊ï◊í◊î ◊û◊ß◊ì◊ô◊û◊î ◊©◊ú ◊î◊î◊ï◊ì◊¢◊î ◊©◊™◊ô◊©◊ú◊ó:\n\n"
            : "üìù Preview of the message to be sent:\n\n") + preview,
        parse_mode: "Markdown",
        reply_markup: {
          inline_keyboard: (draft.buttons || []).concat([
            [{ text: lang === "he" ? "‚úÖ ◊ê◊©◊® ◊ï◊©◊ú◊ó" : "‚úÖ Confirm & Send", callback_data: "panel:bc_send_confirm" }],
            [{ text: lang === "he" ? "‚¨ÖÔ∏è ◊ó◊ñ◊®◊î" : "‚¨ÖÔ∏è Back", callback_data: "panel:bc" }]
          ])
        }
      });
    }

    else if (action === "bc_send_confirm") {
      const draft = settings.broadcast_draft || { text: "", buttons: [] };
      let ok = 0, fail = 0;
      for (const [id, uuser] of Object.entries(users)) {
        if (!uuser.active) continue;
        const textToSend = renderPlaceholders(draft.text || "", uuser, id);
        try {
          await tgPost("sendMessage", {
            chat_id: id,
            text: escapeMarkdown(textToSend),
            parse_mode: "Markdown",
            reply_markup: { inline_keyboard: draft.buttons || [] }
          });
          ok++;
        } catch { fail++; }
      }
      await tgPost("editMessageText", {
        chat_id: msg.chat.id,
        message_id: msg.message_id,
        text:
          lang === "he"
            ? `üì¢ ◊©◊ô◊ì◊ï◊® ◊î◊ï◊©◊ú◊ù!\n‚úÖ ◊†◊©◊ú◊ó◊ï: ${ok}\n‚ùå ◊†◊õ◊©◊ú◊ï: ${fail}`
            : `üì¢ Broadcast completed!\n‚úÖ Sent: ${ok}\n‚ùå Failed: ${fail}`,
        reply_markup: {
          inline_keyboard: [
            [{ text: lang === "he" ? "‚¨ÖÔ∏è ◊ó◊ñ◊®◊î" : "‚¨ÖÔ∏è Back", callback_data: "panel:main" }]
          ]
        }
      });
    }

    else if (action === "lang") {
      const newLang = lang === "he" ? "en" : "he";
      setAdminLang(uid, newLang);
      const tx = newLang === "he" ? PANEL_TEXTS.he.lang_set_he : PANEL_TEXTS.en.lang_set_en;
      await tgPost("answerCallbackQuery", { callback_query_id: cq.id, text: tx });
      await editToMainPanel(msg, newLang);
    }

    else if (action === "summary") {
      const usersCount = Object.keys(users).length;
      await tgPost("editMessageText", {
        chat_id: msg.chat.id,
        message_id: msg.message_id,
        text: `${tt.title()}\n\n${tt.section("Summary")}\n${tt.summary_line(scores, usersCount)}`,
        parse_mode: "Markdown",
        reply_markup: { inline_keyboard: [[{ text: tt.back, callback_data: "panel:main" }]] }
      });
    }

    else if (action === "users") {
      const ids = Object.keys(users);
      const active = ids.filter(id=>users[id].active).length;
      const inactive = ids.length - active;
      const total = ids.length;
      await tgPost("editMessageText", {
        chat_id: msg.chat.id,
        message_id: msg.message_id,
        text: `${tt.title()}\n\n${tt.users_title(active,inactive,total)}`,
        parse_mode: "Markdown",
        reply_markup: {
          inline_keyboard: [
            [{ text: tt.users_export, callback_data: "panel:users_export" }],
            [{ text: tt.back, callback_data: "panel:main" }]
          ]
        }
      });
    }

    else if (action === "users_export") {
      await tgPost("answerCallbackQuery", { callback_query_id: cq.id, text: tt.users_export_sending });
      const header = tt.csv_header;
      const rows = [header];
      for (const [id,u] of Object.entries(users)) {
        const name = (u.displayName||"").replace(/,/g," ");
        const un = (u.username?("@"+u.username):"").replace(/,/g," ");
        const langUser = u.preferredLang || "";
        const country = u.country || "";
        rows.push(`${name},${un},${id},${langUser},${country}`);
      }
      const csv = rows.join("\n");
      const buf = Buffer.from(csv, "utf8");

      const form = new FormData();
      form.append("chat_id", uid);
      form.append("document", buf, { filename: "users_export.csv", contentType: "text/csv" });

      try {
        await axios.post(`${TG_API}/sendDocument`, form, { headers: form.getHeaders() });
        await tgPost("sendMessage", { chat_id: uid, text: tt.users_export_done });
      } catch (e) {
        console.error("CSV send error:", e?.response?.data || e.message);
      }
    }

    else if (action === "bonuses") {
      await tgPost("editMessageText", {
        chat_id: msg.chat.id,
        message_id: msg.message_id,
        text: `${tt.title()}\n\n${tt.section(tt.bonuses_title)}`,
        parse_mode: "Markdown",
        reply_markup: {
          inline_keyboard: [
            [{ text: tt.reset_daily, callback_data: "panel:reset_daily" }],
            [{ text: tt.reset_super, callback_data: "panel:reset_super" }],
            [
              { text: tt.bonus_israel, callback_data: "panel:bonus:israel" },
              { text: tt.bonus_gaza,   callback_data: "panel:bonus:gaza" }
            ],
            [{ text: tt.back, callback_data: "panel:main" }]
          ]
        }
      });
    }

    else if (action === "reset_daily") {
      const today = todayStr();
      for (const k of Object.keys(users)) {
        const u = users[k];
        u.tapsDate = today;
        u.tapsToday = 0;
      }
      writeJSON(USERS_FILE, users);
      await tgPost("answerCallbackQuery", { callback_query_id: cq.id, text: tt.done });
    }

    else if (action === "reset_super") {
      const today = todayStr();
      for (const k of Object.keys(users)) {
        const u = users[k];
        u.superDate = today;
        u.superUsed = 0;
      }
      writeJSON(USERS_FILE, users);
      await tgPost("answerCallbackQuery", { callback_query_id: cq.id, text: tt.done });
    }

    else if (action === "bonus") {
      const team = extra;
      if (team === "israel" || team === "gaza") {
        scores[team] = (scores[team] || 0) + SUPER_POINTS;
        writeJSON(SCORES_FILE, scores);
        await tgPost("answerCallbackQuery", { callback_query_id: cq.id, text: tt.done });
      }
    }

    else if (action === "dxp") {
      await tgPost("editMessageText", {
        chat_id: msg.chat.id,
        message_id: msg.message_id,
        text: `${tt.title()}\n\n${tt.dxp_title(doubleXP)}`,
        parse_mode: "Markdown",
        reply_markup: {
          inline_keyboard: [
            [
              { text: tt.dxp_start, callback_data: "panel:dxp_start" },
              { text: tt.dxp_stop,  callback_data: "panel:dxp_stop" }
            ],
            [
              { text: tt.dxp_hour_minus, callback_data: "panel:dxp_hour:-1" },
              { text: tt.dxp_hour_plus,  callback_data: "panel:dxp_hour:+1" }
            ],
            [
              { text: tt.dxp_duration_minus, callback_data: "panel:dxp_dur:-15" },
              { text: tt.dxp_duration_plus,  callback_data: "panel:dxp_dur:+15" }
            ],
            [{ text: tt.dxp_toggle_daily(doubleXP.dailyEnabled), callback_data: "panel:dxp_toggle_daily" }],
            [{ text: tt.back, callback_data: "panel:main" }]
          ]
        }
      });
    }

    else if (action === "dxp_start") {
      await setDoubleXP(true);
      await broadcastToAllByLang({ he: PANEL_TEXTS.he.dxp_started_all, en: PANEL_TEXTS.en.dxp_started_all });
      await tgPost("answerCallbackQuery", { callback_query_id: cq.id, text: "‚ö° ON" });
      await editToMainPanel(msg, lang);
    }

    else if (action === "dxp_stop") {
      await setDoubleXP(false);
      await broadcastToAllByLang({ he: PANEL_TEXTS.he.dxp_ended_all, en: PANEL_TEXTS.en.dxp_ended_all });
      await tgPost("answerCallbackQuery", { callback_query_id: cq.id, text: "‚èπ OFF" });
      await editToMainPanel(msg, lang);
    }

    else if (action === "dxp_hour") {
      const delta = Number(extra);
      let h = (Number(doubleXP.dailyHourUTC) + delta) % 24;
      if (h < 0) h += 24;
      doubleXP.dailyHourUTC = h;
      writeJSON(DXP_FILE, doubleXP);
      await tgPost("answerCallbackQuery", { callback_query_id: cq.id, text: `UTC ${h}:00` });
      await editToMainPanel(msg, lang);
    }

    else if (action === "dxp_dur") {
      const delta = Number(extra);
      let m = Math.max(15, (Number(doubleXP.durationMin) + delta));
      doubleXP.durationMin = m;
      writeJSON(DXP_FILE, doubleXP);
      await tgPost("answerCallbackQuery", { callback_query_id: cq.id, text: `${m}m` });
      await editToMainPanel(msg, lang);
    }

    else if (action === "dxp_toggle_daily") {
      doubleXP.dailyEnabled = !doubleXP.dailyEnabled;
      writeJSON(DXP_FILE, doubleXP);
      await tgPost("answerCallbackQuery", { callback_query_id: cq.id, text: doubleXP.dailyEnabled ? "üïí on" : "üïí off" });
      await editToMainPanel(msg, lang);
    }

    else if (action === "broadcast") {
      setAdminAwait(uid, "broadcast");
      await tgPost("editMessageText", {
        chat_id: msg.chat.id,
        message_id: msg.message_id,
        text: `${tt.title()}\n\n${tt.ask_broadcast}`,
        parse_mode: "Markdown",
        reply_markup: { inline_keyboard: [[{ text: tt.back, callback_data: "panel:main" }]] }
      });
    }

    else if (action === "admins") {
      const list = tt.admins_list(admins);
      await tgPost("editMessageText", {
        chat_id: msg.chat.id,
        message_id: msg.message_id,
        text: `${tt.title()}\n\n${tt.section(tt.admins_title)}\n\n${list}\n\n${tt.admins_help}`,
        parse_mode: "Markdown",
        reply_markup: { inline_keyboard: [[{ text: tt.back, callback_data: "panel:main" }]] }
      });
    }

    else if (action === "main") {
      await editToMainPanel(msg, lang);
    }

  } // <== ◊°◊ï◊£ else (admins.includes)
  await tgPost("answerCallbackQuery", { callback_query_id: cq.id }).catch(()=>{});
} // <== ◊°◊ï◊£ if (data.startsWith("panel:"))
